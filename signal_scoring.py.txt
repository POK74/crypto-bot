import logging
from analyse_motor import analyze_signals
from sentiment_scraper import get_sentiment_score
from volume_analyzer import get_volume_boost
from whale_tracker import get_whale_boost

logger = logging.getLogger(__name__)

async def generate_final_score(prices: list, coin: str, debug: bool = False) -> dict:
    base_score, base_details = analyze_signals(prices, coin)
    if base_score == 0:
        return {
            "final_score": 0,
            "details": base_details,
            "strength": "âŒ",
            "boosters": {},
            "base_score": base_score
        }

    boosters = {}

    # Feilresistent henting av boosterkomponenter
    try:
        boosters["ğŸ§  Sentiment"] = await get_sentiment_score(coin)
    except Exception as e:
        logger.warning(f"Sentiment booster failed: {e}")
        boosters["ğŸ§  Sentiment"] = 0

    try:
        boosters["ğŸ“Š Volum"] = await get_volume_boost(coin)
    except Exception as e:
        logger.warning(f"Volume booster failed: {e}")
        boosters["ğŸ“Š Volum"] = 0

    try:
        boosters["ğŸ‹ Whale"] = await get_whale_boost(coin)
    except Exception as e:
        logger.warning(f"Whale booster failed: {e}")
        boosters["ğŸ‹ Whale"] = 0

    # Vektet totalscore (kan justeres senere)
    total_boost = (
        boosters["ğŸ§  Sentiment"] * 1.2 +
        boosters["ğŸ“Š Volum"] * 1.0 +
        boosters["ğŸ‹ Whale"] * 0.8
    )
    final_score = min(100, round(base_score + total_boost))

    # Signalstyrke-tagger
    if final_score >= 86:
        strength = "ğŸš€ Sterkt signal"
    elif final_score >= 70:
        strength = "âœ… KjÃ¸pssignal"
    elif final_score >= 60:
        strength = "âš ï¸ Svakt signal"
    else:
        strength = "âŒ For svakt"

    # Kombinert detaljer for Telegram/debug
    booster_details = [f"{emoji} +{boosters[emoji]:.1f}" for emoji in boosters if boosters[emoji] > 0]
    combined_details = (
        f"{base_details}\n"
        f"{' | '.join(booster_details)}\n"
        f"ğŸ§  Totalscore: {final_score}/100 â€” {strength}"
    )

    return {
        "final_score": final_score,
        "details": combined_details,
        "strength": strength,
        "boosters": boosters,
        "base_score": base_score
    }
